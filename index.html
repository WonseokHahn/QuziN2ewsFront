<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizN2ews</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

  <!-- Header -->
  <header class="bg-gradient-to-r from-gray-800 to-blue-600 text-white px-6 py-4 flex flex-col md:flex-row justify-between items-start md:items-center">
    <h1 class="text-2xl font-bold cursor-pointer" onclick="showSection('quiz')">QuizN2ews</h1>
    <nav class="flex gap-3 mt-3 md:mt-0">
      <button onclick="showSection('quiz')" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded text-white">틈새 지식 퀴즈</button>
      <button onclick="showSection('news')" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded text-white">요약 뉴스 피드</button>
    </nav>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto p-6">
    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 flex items-center justify-center bg-black/50 z-50">
      <div class="animate-spin rounded-full h-16 w-16 border-4 border-white border-t-blue-500"></div>
    </div>

    <!-- QUIZ Section -->
    <section id="quiz" class="quiz active">
      <h2 class="text-xl font-semibold mb-4">GPT 퀴즈 생성</h2>
      <div class="flex flex-col sm:flex-row gap-3 mb-4">
        <input type="text" id="topicInput" placeholder="주제를 입력하세요" class="flex-1 border px-4 py-2 rounded" />
        <button onclick="generateQuiz()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">퀴즈 생성</button>
        <button onclick="generateBalanceGame()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">랜덤 밸런스게임</button>
      </div>
      <ul id="quizList" class="space-y-4"></ul>
    </section>

    <!-- NEWS Section -->
    <section id="news" class="news hidden">
      <h2 class="text-xl font-semibold mb-4">네이버 뉴스 검색</h2>
      <div class="flex flex-col sm:flex-row gap-3 mb-4">
        <input type="text" id="newsInput" placeholder="검색어 입력" class="flex-1 border px-4 py-2 rounded" />
        <button onclick="searchNews()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">뉴스 검색</button>
        <button onclick="summarizeNews()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">뉴스 요약 보기</button>
      </div>
      <div id="newsSummary" class="mb-6"></div>
      <ul id="newsList" class="space-y-4"></ul>
    </section>
  </main>

  <!-- Script -->
  <script>
    const apiBase = "https://quizn2ews.onrender.com/api";

    function showSection(section) {
      document.querySelectorAll('.quiz, .news').forEach(el => el.classList.add('hidden'));
      document.getElementById(section).classList.remove('hidden');
    }

    function toggleLoading(show) {
      document.getElementById("loading").classList.toggle("hidden", !show);
    }

    async function generateQuiz() {
      const topic = document.getElementById("topicInput").value || "상식";
      const quizList = document.getElementById("quizList");
      quizList.innerHTML = "";
      toggleLoading(true);
      try {
        const res = await fetch(`${apiBase}/quiz/gpt?topic=${encodeURIComponent(topic)}&count=3`);
        const data = await res.json();
        displayQuiz(data);
      } catch (error) {
        quizList.innerHTML = `<li class="bg-white p-4 rounded-lg shadow">퀴즈 생성 실패: ${error.message}</li>`;
      } finally {
        toggleLoading(false);
      }
    }

    function displayQuiz(data) {
      const quizList = document.getElementById("quizList");
      quizList.innerHTML = "";
      if (!Array.isArray(data)) {
        quizList.innerHTML = `<li class="bg-white p-4 rounded-lg shadow">퀴즈 생성 실패: ${data.error || '알 수 없는 오류'}</li>`;
        return;
      }
      const optionLabels = ['A', 'B', 'C', 'D'];
      data.forEach((quiz, index) => {
        const li = document.createElement("li");
        const answerId = `answer-${index}`;
        const choices = quiz.choices.map((choice, i) => `${optionLabels[i]}. ${choice}`).join("<br>");
        li.innerHTML = `
          <div class="bg-white p-4 rounded-lg shadow">
            <p class="font-semibold mb-2">${index + 1}. ${quiz.question}</p>
            <p class="text-gray-700 mb-2">${choices}</p>
            <span id="${answerId}" class="hidden-answer text-sm text-gray-400 cursor-pointer hover:underline" onclick="toggleAnswer('${answerId}', '${quiz.answer}')">정답 보기</span>
          </div>
        `;
        quizList.appendChild(li);
      });
    }

    function toggleAnswer(id, answer) {
      const el = document.getElementById(id);
      if (el.classList.contains('revealed')) {
        el.textContent = '정답 보기';
        el.classList.remove('revealed');
      } else {
        el.textContent = `정답: ${answer}`;
        el.classList.add('revealed');
      }
    }

    async function generateBalanceGame() {
      const quizList = document.getElementById("quizList");
      quizList.innerHTML = "";
      toggleLoading(true);
      try {
        const res = await fetch(`${apiBase}/quiz/balance?count=1`);
        const data = await res.json();
        if (!Array.isArray(data) || typeof data[0] !== 'string' || !data[0].includes("VS")) {
          quizList.innerHTML = `<li class="bg-white p-4 rounded-lg shadow">밸런스 게임 데이터를 불러오지 못했습니다.</li>`;
          return;
        }
        let processedText = data[0];
        if (processedText.startsWith('"') && processedText.endsWith('"')) {
          processedText = processedText.slice(1, -1);
        }
        const [opt1, opt2] = processedText.split("VS").map(str => str.trim());
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="bg-white p-4 rounded-lg shadow text-center font-bold text-lg">
            ${opt1} <span class="text-gray-500">VS</span> ${opt2}
          </div>
        `;
        quizList.appendChild(li);
      } catch (err) {
        quizList.innerHTML = `<li class="bg-white p-4 rounded-lg shadow">오류 발생: ${err.message}</li>`;
      } finally {
        toggleLoading(false);
      }
    }

    async function searchNews() {
      const query = document.getElementById("newsInput").value || "주요 뉴스";
      const newsList = document.getElementById("newsList");
      const newsSummary = document.getElementById("newsSummary");
      newsList.innerHTML = "";
      newsSummary.innerHTML = "";
      toggleLoading(true);
      try {
        const res = await fetch(`${apiBase}/news/search?q=${encodeURIComponent(query)}&display=5`);
        const data = await res.json();
        if (!Array.isArray(data.items)) {
          newsList.innerHTML = `<li class="bg-white p-4 rounded-lg shadow">뉴스 검색 실패: ${data.error || '알 수 없는 오류'}</li>`;
          return;
        }
        data.items.forEach((item, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow">
              <strong class="text-blue-600">${index + 1}. <a href="${item.link}" target="_blank">${item.title}</a></strong>
              <p class="text-sm text-gray-500">${item.pubDate}</p>
            </div>
          `;
          newsList.appendChild(li);
        });
      } catch (err) {
        newsList.innerHTML = `<li class="bg-white p-4 rounded-lg shadow">뉴스 요청 실패: ${err.message}</li>`;
      } finally {
        toggleLoading(false);
      }
    }

    async function summarizeNews() {
      const query = document.getElementById("newsInput").value || "주요 뉴스";
      const newsSummary = document.getElementById("newsSummary");
      newsSummary.innerHTML = "";
      toggleLoading(true);
      try {
        const res = await fetch(`${apiBase}/news/summary?q=${encodeURIComponent(query)}&display=5`);
        const data = await res.json();
        if (data.summary) {
          newsSummary.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
              <strong class="block mb-2 text-blue-700">뉴스 요약:</strong>
              <p class="whitespace-pre-line">${data.summary}</p>
            </div>
          `;
        } else {
          newsSummary.innerHTML = `<div class="bg-white p-4 rounded-lg shadow">뉴스 요약 실패</div>`;
        }
      } catch (err) {
        newsSummary.innerHTML = `<div class="bg-white p-4 rounded-lg shadow">오류: ${err.message}</div>`;
      } finally {
        toggleLoading(false);
      }
    }
  </script>
</body>
</html>
