<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizN2ews</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #eeeeee;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #444;
      color: white;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      cursor: pointer;
    }
    nav {
      display: flex;
      gap: 10px;
    }
    nav button {
      padding: 0.5rem 1rem;
      border: none;
      background-color: #666;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    nav button:hover {
      background-color: #888;
    }
    .container {
      padding: 1rem;
    }
    .quiz, .news {
      display: none;
    }
    .active {
      display: block;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin-bottom: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    input[type="text"] {
      padding: 0.5rem;
      width: 80%;
      max-width: 300px;
      margin-right: 10px;
      border: 1px solid #bbb;
      border-radius: 5px;
    }
    button.action {
      padding: 0.5rem 1rem;
      background-color: #555;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.action:hover {
      background-color: #333;
    }
    .hidden-answer {
      cursor: pointer;
      color: #aaa;
    }
    .hidden-answer.revealed {
      color: #000;
      font-weight: bold;
    }
    .balance-option {
      display: block;
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      margin: 10px 0;
      color: #444;
    }
    .summary-box {
      white-space: pre-line;
      margin-bottom: 1rem; 
      margin-top: 1rem;      /* 위쪽 여백 추가 */
      padding: 1rem;
      background-color: #f9f9f9;
      border-left: 4px solid #bbb;
      border-radius: 8px;
      color: #222;
    }
    a {
      color: #444;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      nav {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      nav button {
        margin-top: 5px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 onclick="showSection('quiz')">QuizN2ews</h1>
    <nav>
      <button onclick="showSection('quiz')">틈새 지식 퀴즈</button>
      <button onclick="showSection('news')">요약 뉴스 피드</button>
    </nav>
  </header>
  <div class="container">
    <div id="quiz" class="quiz active">
      <h2>GPT 퀴즈 생성</h2>
      <input type="text" id="topicInput" placeholder="주제를 입력하세요" />
      <button class="action" onclick="generateQuiz()">퀴즈 생성</button>
      <button class="action" onclick="generateBalanceGame()">랜덤 밸런스게임</button>
      <ul id="quizList"></ul>
    </div>

    <div id="news" class="news">
      <h2>네이버 뉴스 검색</h2>
      <input type="text" id="newsInput" placeholder="검색어 입력" />
      <button class="action" onclick="searchNews()">뉴스 검색</button>
      <button class="action" onclick="summarizeNews()">뉴스 요약 보기</button>
      <div id="newsSummary"></div>
      <ul id="newsList"></ul>
    </div>
  </div>

  <script>
    const apiBase = "https://quizn2ews.onrender.com/api";

    function showSection(section) {
      document.querySelectorAll('.quiz, .news').forEach(el => el.classList.remove('active'));
      document.getElementById(section).classList.add('active');
    }

    async function generateQuiz() {
      const topic = document.getElementById("topicInput").value || "상식";
      const res = await fetch(`${apiBase}/quiz/gpt?topic=${encodeURIComponent(topic)}&count=3`);
      const data = await res.json();
      displayQuiz(data);
    }

    function displayQuiz(data) {
      const quizList = document.getElementById("quizList");
      quizList.innerHTML = "";
      if (!Array.isArray(data)) {
        quizList.innerHTML = `<li>퀴즈 생성 실패: ${data.error || '알 수 없는 오류'}</li>`;
        return;
      }
      
      const optionLabels = ['A', 'B', 'C', 'D'];
      data.forEach((quiz, index) => {
        const li = document.createElement("li");
        const answerId = `answer-${index}`;
        const choices = quiz.choices.map((choice, i) => `${optionLabels[i]}. ${choice}`).join("<br>");
        li.innerHTML = `
          <strong>${index + 1}. ${quiz.question}</strong><br>
          ${choices}<br>
          <span id="${answerId}" class="hidden-answer" onclick="toggleAnswer('${answerId}', '${quiz.answer}')">정답 보기</span>
        `;
        quizList.appendChild(li);
      });
    }

    function toggleAnswer(id, answer) {
      const el = document.getElementById(id);
      if (el.classList.contains('revealed')) {
        el.textContent = '정답 보기';
        el.classList.remove('revealed');
      } else {
        el.textContent = `정답: ${answer}`;
        el.classList.add('revealed');
      }
    }

    async function generateBalanceGame() {
      const quizList = document.getElementById("quizList");
      quizList.innerHTML = ""; // 기존 목록 초기화

      try {
        const res = await fetch(`${apiBase}/quiz/balance?count=1`);
        const data = await res.json(); // 응답을 JSON으로 파싱

        // 1. 데이터 유효성 및 구조 검사 강화
        // data가 배열이고, 최소한 하나의 문자열 요소(data[0])가 있으며,
        // 그 문자열이 'VS'를 포함하는지 확인
        if (!Array.isArray(data) || data.length === 0 || typeof data[0] !== 'string' || !data[0].includes("VS")) {
          quizList.innerHTML = `<li>밸런스 게임 데이터를 불러오거나 형식이 올바르지 않습니다.</li>`;
          console.error("Invalid or malformed balance game data:", data);
          return;
        }

        // 이 문자열 자체를 questionText로 사용합니다.
        let processedQuestionText = data[0]; 

        // 2. 따옴표 제거 로직 (따옴표가 있을 때만 실행)
        if (processedQuestionText.startsWith('"') && processedQuestionText.endsWith('"')) {
          processedQuestionText = processedQuestionText.slice(1, -1); // 첫 글자와 마지막 글자 제거
        }

        // 3. `split` 대상은 이미 올바르게 처리된 `processedQuestionText`를 사용
        const [opt1, opt2] = processedQuestionText.split("VS").map(str => str.trim());

        const li = document.createElement("li");
        li.innerHTML = `
          <div class="balance-option">${opt1} <span style="margin: 0 10px;">VS</span> ${opt2}</div>
        `;
        quizList.appendChild(li);

      } catch (error) {
        // 네트워크 오류, JSON 파싱 오류 등 예외 처리
        console.error("Failed to generate balance game:", error);
        quizList.innerHTML = `<li>오류 발생: 밸런스 게임을 불러올 수 없습니다.</li>`;
      }
    }
    async function searchNews() {
      const query = document.getElementById("newsInput").value || "주요 뉴스";
      const res = await fetch(`${apiBase}/news/search?q=${encodeURIComponent(query)}&display=5`);
      const data = await res.json();

      const newsList = document.getElementById("newsList");
      const newsSummary = document.getElementById("newsSummary");
      newsSummary.innerHTML = "";
      newsList.innerHTML = "";

      if (!Array.isArray(data.items)) {
        newsList.innerHTML = `<li>뉴스 검색 실패: ${data.error || '알 수 없는 오류'}</li>`;
        return;
      }

      data.items.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${index + 1}. <a href="${item.link}" target="_blank">${item.title}</a></strong><br><small>${item.pubDate}</small>`;
        newsList.appendChild(li);
      });
    }

    async function summarizeNews() {
      const query = document.getElementById("newsInput").value || "주요 뉴스";
      const res = await fetch(`${apiBase}/news/summary?q=${encodeURIComponent(query)}&display=5`);
      const data = await res.json();

      const newsSummary = document.getElementById("newsSummary");
      newsSummary.innerHTML = "";

      if (data.summary) {
        newsSummary.innerHTML = `<div class="summary-box"><strong>뉴스 요약:</strong><br>${data.summary}</div>`;
      } else {
        newsSummary.innerHTML = `<div class="summary-box"><strong>뉴스 요약 실패:</strong> 검색 후 요약본 확인 가능합니다.</div>`;
      }
    }
  </script>
</body>
</html>
